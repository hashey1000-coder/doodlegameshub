# ===========================================================================
# Doodle Games Hub — Apache / cPanel Static Hosting
# ===========================================================================

# ---------------------------------------------------------------------------
# 1. Custom Error Pages
# ---------------------------------------------------------------------------
ErrorDocument 404 /404.html
ErrorDocument 403 /404.html

# ---------------------------------------------------------------------------
# 2. Rewrite Engine
# ---------------------------------------------------------------------------
<IfModule mod_rewrite.c>
  RewriteEngine On

  # --- Force HTTPS ---
  RewriteCond %{HTTPS} !=on
  RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

  # --- Remove www (uncomment if using bare domain) ---
  # RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
  # RewriteRule ^ https://%1%{REQUEST_URI} [L,R=301]
  # --- SEO Redirects: common old/alternate URLs ---
  RewriteRule ^a-z/?$ /games/ [R=301,L]
  RewriteRule ^az/?$ /games/ [R=301,L]
  RewriteRule ^leaderboard/?$ /top-rated/ [R=301,L]
  RewriteRule ^kids/?$ /?kidsMode=true [R=301,L]
  # /games/:slug/ → /play/:slug/  (old URL pattern)
  RewriteRule ^games/([^/]+)/?$ /play/$1/ [R=301,L]
  # Locale-aware variants of the above
  RewriteRule ^(es|fr|de|it|pt|ru|zh-CN|zh-TW|ja|ko|ar|hi|tr|nl|pl|sv|id|vi|th)/a-z/?$ /$1/games/ [R=301,L]
  RewriteRule ^(es|fr|de|it|pt|ru|zh-CN|zh-TW|ja|ko|ar|hi|tr|nl|pl|sv|id|vi|th)/az/?$ /$1/games/ [R=301,L]
  RewriteRule ^(es|fr|de|it|pt|ru|zh-CN|zh-TW|ja|ko|ar|hi|tr|nl|pl|sv|id|vi|th)/leaderboard/?$ /$1/top-rated/ [R=301,L]
  RewriteRule ^(es|fr|de|it|pt|ru|zh-CN|zh-TW|ja|ko|ar|hi|tr|nl|pl|sv|id|vi|th)/kids/?$ /$1/?kidsMode=true [R=301,L]
  RewriteRule ^(es|fr|de|it|pt|ru|zh-CN|zh-TW|ja|ko|ar|hi|tr|nl|pl|sv|id|vi|th)/games/([^/]+)/?$ /$1/play/$2/ [R=301,L]
  # --- Trailing slash enforcement ---
  # Add trailing slash to URLs that:
  #   - are not files (no extension)
  #   - don't already end with /
  #   - are not asset paths (/assets/, /thumbnails/)
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_URI} !\.([a-zA-Z0-9]{2,5})$
  RewriteCond %{REQUEST_URI} !(.*)/$
  RewriteRule ^(.*)$ /$1/ [L,R=301]

  # --- Serve index.html for directory URLs ---
  # e.g. /es/play/pacman/ → /es/play/pacman/index.html
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteCond %{REQUEST_FILENAME}/index.html -f
  RewriteRule ^(.*)$ $1/index.html [L]

  # --- Locale-aware 404 fallback ---
  # If a non-English locale path doesn't match a file, try /<locale>/404.html
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_URI} ^/(es|fr|de|it|pt|ru|zh-CN|zh-TW|ja|ko|ar|hi|tr|nl|pl|sv|id|vi|th)/
  RewriteRule ^(es|fr|de|it|pt|ru|zh-CN|zh-TW|ja|ko|ar|hi|tr|nl|pl|sv|id|vi|th)/.* /$1/404.html [L]

  # --- English 404 fallback (catch-all) ---
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule ^ /404.html [L]
</IfModule>

# ---------------------------------------------------------------------------
# 3. Compression (mod_deflate)
# ---------------------------------------------------------------------------
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/json
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE text/xml
  AddOutputFilterByType DEFLATE image/svg+xml
  AddOutputFilterByType DEFLATE application/xhtml+xml
</IfModule>

# ---------------------------------------------------------------------------
# 4. Browser Caching (mod_expires)
# ---------------------------------------------------------------------------
<IfModule mod_expires.c>
  ExpiresActive On

  # HTML — short cache (content changes with new builds)
  ExpiresByType text/html "access plus 1 hour"

  # CSS & JS — long cache (filenames are hashed by Vite)
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType text/javascript "access plus 1 year"

  # Images — long cache
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"

  # Fonts
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType application/font-woff2 "access plus 1 year"

  # Fallback
  ExpiresDefault "access plus 1 week"
</IfModule>

# --- Cache-Control for hashed assets (Vite output) ---
<IfModule mod_headers.c>
  <FilesMatch "\.(js|css)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
  <FilesMatch "\.(html)$">
    Header set Cache-Control "public, max-age=3600, must-revalidate"
  </FilesMatch>
</IfModule>

# ---------------------------------------------------------------------------
# 5. Security Headers
# ---------------------------------------------------------------------------
<IfModule mod_headers.c>
  # Prevent MIME-type sniffing
  Header set X-Content-Type-Options "nosniff"

  # Unset nosniff for image files to avoid browser blocking with incorrect MIME
  <FilesMatch "\.(png|jpg|jpeg|gif|webp|svg|ico)$">
    Header unset X-Content-Type-Options
  </FilesMatch>

  # Clickjacking protection (allow iframes for game embeds from same origin)
  Header set X-Frame-Options "SAMEORIGIN"

  # XSS protection
  Header set X-XSS-Protection "1; mode=block"

  # Referrer policy
  Header set Referrer-Policy "strict-origin-when-cross-origin"

  # Permissions policy
  Header set Permissions-Policy "camera=(), microphone=(), geolocation=()"
</IfModule>

# ---------------------------------------------------------------------------
# 6. MIME Types
# ---------------------------------------------------------------------------
<IfModule mod_mime.c>
  AddType application/javascript .js .mjs
  AddType text/css .css
  AddType image/webp .webp
  AddType image/svg+xml .svg
  AddType image/png .png
  AddType image/jpeg .jpg .jpeg
  AddType image/gif .gif
  AddType application/json .json
  AddType application/manifest+json .webmanifest
  AddType font/woff2 .woff2
</IfModule>

# ---------------------------------------------------------------------------
# 7. Prevent Directory Listing
# ---------------------------------------------------------------------------
Options -Indexes

# ---------------------------------------------------------------------------
# 8. Thumbnail / image serving — ensure correct headers
# ---------------------------------------------------------------------------
<IfModule mod_headers.c>
  <FilesMatch "\.(png|jpg|jpeg|gif|webp|svg)$">
    Header set Access-Control-Allow-Origin "*"
    Header unset X-Content-Type-Options
  </FilesMatch>
</IfModule>

# ---------------------------------------------------------------------------
# 9. Prevent access to hidden files (except .htaccess itself)
# ---------------------------------------------------------------------------
<FilesMatch "^\.(?!htaccess)">
  <IfModule mod_authz_core.c>
    Require all denied
  </IfModule>
</FilesMatch>
